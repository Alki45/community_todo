rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================
    // Users collection
    // =========================
    match /users/{uid} {
      // Allow authenticated users to read any user profile (for search functionality)
      allow read: if request.auth != null;
      
      // Users can create their own profile
      allow create: if request.auth != null && request.auth.uid == uid;
      
      // Users can update their own profile (any field)
      allow update: if request.auth != null && request.auth.uid == uid;
      
      // Allow updating only the groups field when adding members to groups
      // This is needed for addMemberToGroup and joinGroupByCode operations
      allow update: if request.auth != null &&
                    // Only the groups field is being updated
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['groups']) &&
                    // The new groups array must contain all old groups (only additions allowed)
                    (!('groups' in resource.data) || 
                     request.resource.data.groups.hasAll(resource.data.groups));
      
      // Prevent deletion of user profiles
      allow delete: if false;
    }

    // =========================
    // Community announcements
    // =========================
    match /community/{docId} {
      allow read, write: if request.auth != null;
    }

    // =========================
    // Groups collection
    // =========================
    match /groups/{groupId} {
      allow read: if request.auth != null;

      // Allow authenticated users to create groups where they are the admin
      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.admin_uid &&
                    request.auth.uid in request.resource.data.member_ids;

      // Admin can update any field (including adding/removing members)
      allow update: if request.auth != null &&
                    request.auth.uid == resource.data.admin_uid;

      // Members can vote, but cannot directly change adminUid
      allow update: if request.auth != null &&
                    request.auth.uid in resource.data.member_ids &&
                    request.resource.data.keys().hasOnly(['admin_votes']) &&
                    !('admin_uid' in request.resource.data);

      // Allow members to be added/removed (for addMemberToGroup and leaveGroup)
      // This allows admins to add members and members to leave
      allow update: if request.auth != null &&
                    (request.auth.uid == resource.data.admin_uid ||
                     (request.auth.uid in resource.data.member_ids &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'member_ids', 'admin_votes'])));

      // Only admin can delete the group
      allow delete: if request.auth != null && request.auth.uid == resource.data.admin_uid;

      // Subcollections
      match /announcements/{announcementId} {
        // Authenticated members can create and read announcements
        allow read, write: if request.auth != null &&
                           request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.member_ids;
      }
    }

    // =========================
    // Recitations collection
    // =========================
    match /recitations/{recitationId} {
      allow read: if request.auth != null && request.auth.uid != null;

      // Allow group admins to create recitations
      allow create: if request.auth != null &&
                    exists(/databases/$(database)/documents/groups/$(request.resource.data.group_id)) &&
                    request.auth.uid == get(/databases/$(database)/documents/groups/$(request.resource.data.group_id)).data.admin_uid;

      // Only admin or assigned member can update status
      allow update: if request.auth != null &&
                    (request.auth.uid == resource.data.assigned_to ||
                     request.auth.uid == get(/databases/$(database)/documents/groups/$(resource.data.group_id)).data.admin_uid);
    }

    // =========================
    // Join requests collection
    // =========================
    match /join_requests/{requestId} {
      allow read: if request.auth != null && (
                    request.auth.uid == resource.data.user_id || 
                    request.auth.uid == get(/databases/$(database)/documents/groups/$(resource.data.group_id)).data.admin_uid
                  );
      allow create: if request.auth != null && request.auth.uid == request.resource.data.user_id;
      allow update: if request.auth != null &&
                    request.auth.uid == get(/databases/$(database)/documents/groups/$(resource.data.group_id)).data.admin_uid;
      allow delete: if false; // Never allow direct deletion
    }

    // =========================
    // Announcements collection (community-wide)
    // =========================
    match /announcements/{announcementId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null;
    }
  }
}
